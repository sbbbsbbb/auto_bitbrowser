<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰‡ç®¡ç† - Web Admin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’³ å¡ç‰‡ç®¡ç†</h1>
            <nav class="nav-links">
                <a href="/">è´¦å·ç®¡ç†</a>
                <a href="/proxies">ä»£ç†ç®¡ç†</a>
                <a href="/cards" class="active">å¡ç‰‡ç®¡ç†</a>
            </nav>
        </header>

        <div class="card">
            <div class="toolbar">
                <button id="btnImport" class="btn-success">ğŸ“¥ å¯¼å…¥å¡ç‰‡</button>
                <button id="btnDelete" class="btn-danger">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                <button id="btnClear" class="btn-warning">âš ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                <span class="spacer"></span>
                <span id="countDisplay">åŠ è½½ä¸­...</span>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>ID</th>
                            <th>å¡å·</th>
                            <th>æœ‰æ•ˆæœŸ</th>
                            <th>CVV</th>
                            <th>æŒå¡äºº</th>
                            <th>ä½¿ç”¨æ¬¡æ•°</th>
                            <th>æœ€å¤§æ¬¡æ•°</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="cardTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">å¯¼å…¥å¡ç‰‡</div>
            <div class="modal-body">
                <p>è¾“å…¥å¡ç‰‡ä¿¡æ¯ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</p>
                <textarea id="importText" rows="10" style="width: 100%; font-family: monospace; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰ï¼š
å¡å· æœˆ å¹´ CVV [æŒå¡äººå§“å]

ç¤ºä¾‹ï¼š
4111111111111111 12 2025 123
5500000000000004 01 2026 456 John Doe"></textarea>
                
                <div style="margin-top: 15px;">
                    <label><strong>ä¸€å¡æœ€å¤šç»‘å®šæ¬¡æ•°ï¼š</strong></label>
                    <input type="number" id="maxUsage" value="1" min="1" max="100" 
                           style="padding: 5px; margin-left: 10px; width: 80px;">
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelImport" class="btn-secondary">å–æ¶ˆ</button>
                <button id="btnConfirmImport" class="btn-success">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        let allCards = [];
        
        // åŠ è½½å¡ç‰‡åˆ—è¡¨
        async function loadCards() {
            try {
                const response = await fetch('/api/cards');
                allCards = await response.json();
                renderTable();
            } catch (e) {
                console.error('åŠ è½½å¡ç‰‡å¤±è´¥:', e);
            }
        }
        
        // é®ç½©å¡å·
        function maskCardNumber(number) {
            if (!number || number.length < 8) return number;
            return number.slice(0, 4) + ' â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + number.slice(-4);
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('cardTableBody');
            tbody.innerHTML = '';
            
            const available = allCards.filter(c => c.is_active && c.usage_count < c.max_usage).length;
            document.getElementById('countDisplay').textContent = 
                `å…± ${allCards.length} å¼ å¡ç‰‡ï¼Œå¯ç”¨ ${available} å¼ `;
            
            allCards.forEach(card => {
                const isAvailable = card.is_active && card.usage_count < card.max_usage;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-id="${card.id}"></td>
                    <td>${card.id}</td>
                    <td style="font-family: monospace;">${maskCardNumber(card.card_number)}</td>
                    <td>${card.exp_month}/${card.exp_year}</td>
                    <td>â€¢â€¢â€¢</td>
                    <td>${card.holder_name || '-'}</td>
                    <td>${card.usage_count}</td>
                    <td>${card.max_usage}</td>
                    <td>
                        <span class="status-badge ${isAvailable ? 'status-verified' : 'status-ineligible'}">
                            ${isAvailable ? 'å¯ç”¨' : (card.is_active ? 'å·²ç”¨å®Œ' : 'å·²ç¦ç”¨')}
                        </span>
                    </td>
                    <td>
                        <button class="btn-sm ${card.is_active ? 'btn-warning' : 'btn-success'}" 
                                onclick="toggleCard(${card.id}, ${!card.is_active})">
                            ${card.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // åˆ‡æ¢å¡ç‰‡çŠ¶æ€
        async function toggleCard(id, isActive) {
            try {
                await fetch('/api/cards/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id, is_active: isActive})
                });
                loadCards();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥: ' + e.message);
            }
        }
        
        // å…¨é€‰
        document.getElementById('selectAll').addEventListener('change', function() {
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = this.checked);
        });
        
        // è·å–é€‰ä¸­çš„ID
        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.row-checkbox:checked'))
                .map(cb => parseInt(cb.dataset.id));
        }
        
        // å¯¼å…¥æŒ‰é’®
        document.getElementById('btnImport').addEventListener('click', () => {
            document.getElementById('importModal').style.display = 'block';
        });
        
        document.getElementById('btnCancelImport').addEventListener('click', () => {
            document.getElementById('importModal').style.display = 'none';
        });
        
        document.getElementById('btnConfirmImport').addEventListener('click', async () => {
            const text = document.getElementById('importText').value.trim();
            const maxUsage = parseInt(document.getElementById('maxUsage').value) || 1;
            
            if (!text) {
                alert('è¯·è¾“å…¥å¡ç‰‡ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch('/api/cards/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cards: text, max_usage: maxUsage})
                });
                
                const result = await response.json();
                alert(`å¯¼å…¥å®Œæˆï¼\næˆåŠŸ: ${result.imported}\nå¤±è´¥: ${result.errors}`);
                
                document.getElementById('importModal').style.display = 'none';
                document.getElementById('importText').value = '';
                loadCards();
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: ' + e.message);
            }
        });
        
        // åˆ é™¤æŒ‰é’®
        document.getElementById('btnDelete').addEventListener('click', async () => {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¡ç‰‡');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} å¼ å¡ç‰‡å—ï¼Ÿ`)) return;
            
            try {
                await fetch('/api/cards/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: ids})
                });
                loadCards();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        });
        
        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('btnClear').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¡ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                await fetch('/api/cards/clear', {method: 'POST'});
                loadCards();
            } catch (e) {
                alert('æ¸…ç©ºå¤±è´¥: ' + e.message);
            }
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // åˆå§‹åŠ è½½
        loadCards();
    </script>
</body>
</html>
