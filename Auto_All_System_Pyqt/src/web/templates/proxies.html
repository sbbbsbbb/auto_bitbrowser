<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç†ç®¡ç† - Web Admin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ ä»£ç†ç®¡ç†</h1>
            <nav class="nav-links">
                <a href="/">è´¦å·ç®¡ç†</a>
                <a href="/proxies" class="active">ä»£ç†ç®¡ç†</a>
                <a href="/cards">å¡ç‰‡ç®¡ç†</a>
            </nav>
        </header>

        <div class="card">
            <div class="toolbar">
                <button id="btnImport" class="btn-success">ğŸ“¥ å¯¼å…¥ä»£ç†</button>
                <button id="btnDelete" class="btn-danger">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                <button id="btnClear" class="btn-warning">âš ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                <span class="spacer"></span>
                <span id="countDisplay">åŠ è½½ä¸­...</span>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>ID</th>
                            <th>ç±»å‹</th>
                            <th>ä¸»æœº</th>
                            <th>ç«¯å£</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å¯†ç </th>
                            <th>çŠ¶æ€</th>
                            <th>å·²åˆ†é…ç»™</th>
                        </tr>
                    </thead>
                    <tbody id="proxyTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">å¯¼å…¥ä»£ç†</div>
            <div class="modal-body">
                <p>è¾“å…¥ä»£ç†ä¿¡æ¯ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</p>
                <textarea id="importText" rows="10" style="width: 100%; font-family: monospace; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š
socks5://user:pass@host:port
host:port:user:pass
host:port"></textarea>
                
                <div style="margin-top: 15px;">
                    <label><strong>ä»£ç†ç±»å‹ï¼š</strong></label>
                    <select id="proxyType" style="padding: 5px; margin-left: 10px;">
                        <option value="socks5" selected>SOCKS5</option>
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelImport" class="btn-secondary">å–æ¶ˆ</button>
                <button id="btnConfirmImport" class="btn-success">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        let allProxies = [];
        
        // åŠ è½½ä»£ç†åˆ—è¡¨
        async function loadProxies() {
            try {
                const response = await fetch('/api/proxies');
                allProxies = await response.json();
                renderTable();
            } catch (e) {
                console.error('åŠ è½½ä»£ç†å¤±è´¥:', e);
            }
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('proxyTableBody');
            tbody.innerHTML = '';
            
            document.getElementById('countDisplay').textContent = `å…± ${allProxies.length} ä¸ªä»£ç†`;
            
            allProxies.forEach(proxy => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-id="${proxy.id}"></td>
                    <td>${proxy.id}</td>
                    <td>${proxy.proxy_type || 'socks5'}</td>
                    <td>${proxy.host}</td>
                    <td>${proxy.port}</td>
                    <td>${proxy.username || '-'}</td>
                    <td>${proxy.password ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : '-'}</td>
                    <td><span class="status-badge ${proxy.is_used ? 'status-subscribed' : 'status-pending_check'}">${proxy.is_used ? 'å·²ä½¿ç”¨' : 'å¯ç”¨'}</span></td>
                    <td>${proxy.used_by || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // å…¨é€‰
        document.getElementById('selectAll').addEventListener('change', function() {
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = this.checked);
        });
        
        // è·å–é€‰ä¸­çš„ID
        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.row-checkbox:checked'))
                .map(cb => parseInt(cb.dataset.id));
        }
        
        // å¯¼å…¥æŒ‰é’®
        document.getElementById('btnImport').addEventListener('click', () => {
            document.getElementById('importModal').style.display = 'block';
        });
        
        document.getElementById('btnCancelImport').addEventListener('click', () => {
            document.getElementById('importModal').style.display = 'none';
        });
        
        document.getElementById('btnConfirmImport').addEventListener('click', async () => {
            const text = document.getElementById('importText').value.trim();
            const type = document.getElementById('proxyType').value;
            
            if (!text) {
                alert('è¯·è¾“å…¥ä»£ç†ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch('/api/proxies/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({proxies: text, type: type})
                });
                
                const result = await response.json();
                alert(`å¯¼å…¥å®Œæˆï¼\næˆåŠŸ: ${result.imported}\nå¤±è´¥: ${result.errors}`);
                
                document.getElementById('importModal').style.display = 'none';
                document.getElementById('importText').value = '';
                loadProxies();
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: ' + e.message);
            }
        });
        
        // åˆ é™¤æŒ‰é’®
        document.getElementById('btnDelete').addEventListener('click', async () => {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»£ç†');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªä»£ç†å—ï¼Ÿ`)) return;
            
            try {
                await fetch('/api/proxies/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: ids})
                });
                loadProxies();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        });
        
        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('btnClear').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»£ç†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                await fetch('/api/proxies/clear', {method: 'POST'});
                loadProxies();
            } catch (e) {
                alert('æ¸…ç©ºå¤±è´¥: ' + e.message);
            }
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // åˆå§‹åŠ è½½
        loadProxies();
    </script>
</body>
</html>
